<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>dupfinder - Web Launcher</title>
  <style>
    body{font-family:Segoe UI,Roboto,Arial;background:#f4f6fb;color:#222;padding:20px}
    .card{max-width:900px;margin:20px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .row{display:flex;gap:12px;align-items:center}
    input[type=text]{flex:1;padding:10px;border:1px solid #ddd;border-radius:6px}
    button{padding:10px 14px;border-radius:6px;border:0;background:#4f46e5;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:13px}
    .stats{display:flex;gap:12px;margin-top:12px}
    .stat{background:#eef2ff;padding:12px;border-radius:6px;flex:1}
    pre{background:#0b1220;color:#fff;padding:12px;border-radius:6px;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h2>dupfinder - Web Launcher</h2>
    <p class="muted">Select a local folder (runs scans on your machine via local server)</p>
    <div class="row">
      <input id="folderPath" type="text" placeholder="Enter folder path or click Browse" />
      <button onclick="browse()">Browse</button>
      <button onclick="changeFolder()">Use Folder</button>
    </div>
    <div style="margin-top:12px">
      <button onclick="startScan()">Start Scan</button>
      <button onclick="refreshProgress()">Refresh Progress</button>
      <button onclick="deleteAll()">Delete All Duplicates</button>
      <button onclick="exportReport()">Export Report</button>
    </div>
    <div class="stats" id="stats" style="margin-top:12px">
      <div class="stat"><div>Total Files</div><div id="totalFiles">0</div></div>
      <div class="stat"><div>Duplicate Groups</div><div id="groups">0</div></div>
      <div class="stat"><div>Space (bytes)</div><div id="space">0</div></div>
    </div>
    <div style="margin-top:12px">
      <h3>Raw API output</h3>
      <pre id="output">(no output)</pre>
    </div>
  </div>

  <script>
    const BASE = 'http://localhost:8888';
    async function browse(){
      alert('Use system file dialog to pick folder path and paste it into the input. (Browsers hosted remotely cannot access your filesystem directly.)');
    }
    async function changeFolder(){
      const p = document.getElementById('folderPath').value.trim();
      if(!p) return alert('Enter a folder path');
      const res = await fetch(BASE + '/api/change-folder', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:p})});
      const j = await res.json();
      document.getElementById('output').textContent = JSON.stringify(j,null,2);
    }
    async function startScan(){
      // ensure server is running
      try{ await fetch(BASE + '/api/progress'); }
      catch(e){ return alert('Cannot contact local server at '+BASE+' - start it first on your machine'); }
      // just call progress which will start scan if folder set
      await refreshSummary();
      await refreshDuplicates();
    }
    async function refreshProgress(){
      const r = await fetch(BASE + '/api/progress');
      const j = await r.json();
      document.getElementById('output').textContent = JSON.stringify(j,null,2);
    }
    async function refreshSummary(){
      const r = await fetch(BASE + '/api/summary');
      const j = await r.json();
      document.getElementById('totalFiles').textContent = j.files||0;
      document.getElementById('groups').textContent = j.groups||0;
      document.getElementById('space').textContent = j.space||0;
      document.getElementById('output').textContent = JSON.stringify(j,null,2);
    }
    async function refreshDuplicates(){
      const r = await fetch(BASE + '/api/duplicates');
      const j = await r.json();
      document.getElementById('output').textContent = JSON.stringify(j,null,2);
    }
    async function deleteAll(){
      if(!confirm('Delete all duplicates (keeps one per group)?')) return;
      const r = await fetch(BASE + '/api/delete-all', {method:'POST'});
      const j = await r.json();
      alert('Deleted: '+(j.deleted||0)+' Freed bytes: '+(j.freed||0));
      refreshSummary();
    }
    async function exportReport(){
      const r = await fetch(BASE + '/api/summary');
      const s = await r.json();
      const d = await fetch(BASE + '/api/duplicates');
      const g = await d.json();
      const report = {summary:s, groups:g};
      const blob = new Blob([JSON.stringify(report,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'dupfinder-report.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
